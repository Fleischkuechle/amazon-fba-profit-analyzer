<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="title_app">eBay Profit Rechner (inkl. Progression)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for custom theme -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'ebay-dark': '#1e293b',
                        'ebay-medium': '#334155',
                        'ebay-light': '#475569',
                        'profit-green': '#10b981',
                        'loss-red': '#ef4444',
                        'accent-blue': '#38bdf8',
                        'ebay-primary': '#a3a3a3',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* General styling adjustments for better UX */
        input[type="number"],
        select {
            background-color: #334155;
            color: white;
            border: 1px solid #475569;
        }

        input[type="number"]:focus,
        select[type="number"]:focus {
            outline: none;
            border-color: #38bdf8;
            box-shadow: 0 0 0 1px #38bdf8;
        }

        /* Hide number input arrows */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }

        /* Styling for the new label indicators */
        .label-indicator {
            font-weight: normal;
            margin-top: 4px;
            font-size: 0.75rem;
            line-height: 1rem;
            color: #94a3b8;
        }

        /* Styling for the details summary button */
        details summary {
            cursor: pointer;
            padding: 0.5rem 0;
            outline: none;
            list-style: none;
            font-weight: 600;
        }

        details summary::-webkit-details-marker {
            display: none;
        }

        details[open] summary::after {
            content: '▼';
            float: right;
            transition: transform 0.2s;
            font-size: 0.8rem;
            color: #94a3b8;
        }

        details[open] summary::after {
            content: '▲';
        }

        .tax-scheme-option {
            transition: all 0.2s;
            cursor: pointer;
        }

        .tax-scheme-option.selected {
            background-color: #38bdf8;
            /* accent-blue */
            color: #1e293b;
            /* ebay-dark */
            font-weight: bold;
        }

        .cogs-info-box {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background-color: #334155;
            border-radius: 0.5rem;
        }

        /* Styling for COGS Input Type Buttons */
        .cogs-input-type-btn.selected {
            background-color: #2563eb;
            /* A darker, firm blue for selection */
            border-color: #2563eb;
            color: white;
            font-weight: bold;
        }

        /* Mobile adjustment for input grid */
        @media (max-width: 639px) {
            .input-grid-2-cols>div {
                grid-column: span 2 / span 2;
                /* Make all input fields full width on mobile */
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>

<body class="bg-ebay-dark min-h-screen p-4 font-sans text-white">

    <div class="max-w-3xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-ebay-primary" data-i18n="title_app">eBay Profit Rechner
                (inkl. Progression)</h1>
            <p class="text-ebay-light mt-1 text-sm sm:text-base" data-i18n="subtitle_app">Berechnung von Rentabilität,
                Steuern und Kennzahlen für Deutschland.</p>
        </header>

        <div class="bg-ebay-medium p-4 sm:p-6 rounded-xl shadow-2xl space-y-6">

            <!-- LANGUAGE SETTING -->
            <div class="flex justify-end mb-4">
                <select id="languageSelector" onchange="setLanguage(this.value)"
                    class="p-2 rounded-lg text-sm bg-ebay-light text-white border border-ebay-light">
                    <option value="de" data-i18n="lang_de">Deutsch</option>
                    <option value="en" data-i18n="lang_en">English</option>
                </select>
            </div>

            <!-- TAX SCHEME SELECTION -->
            <section class="mb-6">
                <h2 class="text-xl font-bold text-gray-200 border-b border-ebay-light pb-2 mb-4"
                    data-i18n="h2_tax_scheme">Steuerliches Szenario wählen</h2>
                <div id="taxSchemeSelection" class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div id="scheme_small_business" onclick="setTaxScheme('small_business')"
                        class="tax-scheme-option p-4 rounded-xl bg-ebay-light border border-ebay-light hover:border-accent-blue selected">
                        <p class="font-bold" data-i18n="scheme_small_business_title">Kleinunternehmer</p>
                        <p class="text-xs text-gray-400" data-i18n="scheme_small_business_desc">Keine MwSt. auf
                            Verkäufe/Gebühren.</p>
                    </div>
                    <div id="scheme_standard_vat" onclick="setTaxScheme('standard_vat')"
                        class="tax-scheme-option p-4 rounded-xl bg-ebay-light border border-ebay-light hover:border-accent-blue">
                        <p class="font-bold" data-i18n="scheme_standard_vat_title">Standard-MwSt. (19%)</p>
                        <p class="text-xs text-gray-400" data-i18n="scheme_standard_vat_desc">MwSt. auf Verkauf
                            abführen, Vorsteuer auf Gebühren abziehen.</p>
                    </div>
                    <div id="scheme_margin_tax" onclick="setTaxScheme('margin_tax')"
                        class="tax-scheme-option p-4 rounded-xl bg-ebay-light border border-ebay-light hover:border-accent-blue">
                        <p class="font-bold" data-i18n="scheme_margin_tax_title">Differenzbesteuerung</p>
                        <p class="text-xs text-gray-400" data-i18n="scheme_margin_tax_desc">MwSt. nur auf die Marge
                            (Einkauf von Privat).</p>
                    </div>
                </div>
            </section>

            <!-- INPUTS SECTION -->
            <section class="space-y-4">
                <h2 class="text-xl font-bold text-gray-200 border-b border-ebay-light pb-2"
                    data-i18n="h2_primary_inputs">Primäre Finanzielle Eingaben</h2>

                <!-- Primary Inputs (Always Visible: Price & COGS) -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">

                    <div>
                        <label for="sellingPrice" class="flex flex-col text-sm font-medium text-gray-300">
                            <span data-i18n="label_selling_price">Verkaufspreis Brutto (€)</span>
                            <span id="minPriceValue" class="label-indicator"></span>
                        </label>
                        <input type="number" id="sellingPrice" value="25.00" min="0.01" step="0.01"
                            oninput="updateProfit()"
                            class="mt-1 w-full p-2 rounded-lg transition-all focus:ring-1 focus:ring-accent-blue">
                    </div>

                    <div>
                        <label for="cogs" class="flex flex-col text-sm font-medium text-gray-300">
                            <span data-i18n="label_cogs">Kosten der Waren (Einkaufspreis) (€)</span>
                        </label>
                        <span id="maxCogsValueContainer" class="label-indicator block mt-1"></span>
                        <!-- Max COGS calculation -->
                        <input type="number" id="cogs" value="5.00" min="0" step="0.01" oninput="updateProfit()"
                            class="mt-1 w-full p-2 rounded-lg transition-all focus:ring-1 focus:ring-accent-blue">

                        <!-- COGS Input Type Selector for Standard VAT only -->
                        <div id="cogsInputTypeSelector" class="mt-2 hidden">
                            <label class="block text-xs font-medium text-gray-400 mb-1"
                                data-i18n="label_cogs_input_type">Eingabewert COGS:</label>
                            <div class="flex space-x-2">
                                <button id="cogs_input_gross_btn" onclick="setCogsInputType('gross')"
                                    class="cogs-input-type-btn px-3 py-1 text-xs rounded-full bg-ebay-light border border-ebay-light hover:border-accent-blue"
                                    data-i18n="cogs_input_gross">Brutto</button>
                                <button id="cogs_input_net_btn" onclick="setCogsInputType('net')"
                                    class="cogs-input-type-btn px-3 py-1 text-xs rounded-full bg-ebay-light border border-ebay-light hover:border-accent-blue selected"
                                    data-i18n="cogs_input_net">Netto</button>
                            </div>
                        </div>

                        <!-- Dynamic Hint for COGS Input (Explicit Brutto/Netto instruction) -->
                        <span id="cogsTaxHint" class="label-indicator block mt-1 text-yellow-300 font-semibold"></span>

                        <!-- Dynamic VAT Amount for Standard VAT Scheme -->
                        <div id="cogsVATAmountContainer" class="cogs-info-box border border-accent-blue hidden">
                            <span class="text-xs font-medium text-gray-300" data-i18n="label_cogs_vat_amount">
                                Davon Vorsteuer (erstattungsfähig):
                            </span>
                            <span id="cogsVATAmount" class="text-sm font-bold text-profit-green float-right"></span>
                        </div>

                    </div>
                </div>

                <!-- Collapsible Detail Inputs (Fees, Volume, and Target Profit) -->
                <details class="rounded-xl bg-ebay-light p-4 shadow-inner mt-6">
                    <summary class="text-gray-200 hover:text-accent-blue transition-colors" data-i18n="summary_details">
                        Detaillierte Kosten & Steuerparameter</summary>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-4 border-t border-ebay-medium mt-2">

                        <!-- TARGET PROFIT -->
                        <div>
                            <label for="targetProfit" class="block text-sm font-medium text-gray-300"
                                data-i18n="label_target_profit">
                                Ziel-Nettogewinn (vor ESt) (€)
                            </label>
                            <input type="number" id="targetProfit" value="5.00" min="0" step="0.01"
                                oninput="updateProfit()"
                                class="mt-1 w-full p-2 rounded-lg transition-all focus:ring-1 focus:ring-accent-blue">
                        </div>

                        <!-- TAX YEAR -->
                        <div>
                            <label for="taxYear" class="block text-sm font-medium text-gray-300">
                                Steuerjahr (Basis für Freibetrag)
                            </label>
                            <input type="number" id="taxYear" value="2024" min="2020" step="1" oninput="updateProfit()"
                                class="mt-1 w-full p-2 rounded-lg transition-all focus:ring-1 focus:ring-accent-blue">
                            <span class="label-indicator block mt-1">Basis: Grundfreibetrag 2024 (11.604 € -
                                Ledig)</span>
                        </div>

                        <!-- ALREADY EARNED INCOME (ZvE) -->
                        <div>
                            <label for="alreadyEarnedIncome" class="block text-sm font-medium text-gray-300"
                                data-i18n="label_already_earned_income">
                                Bisheriges Jahres-ZvE (Zu versteuerndes Einkommen) (€)
                            </label>
                            <input type="number" id="alreadyEarnedIncome" value="500.00" min="0" step="100.00"
                                oninput="updateProfit()"
                                class="mt-1 w-full p-2 rounded-lg transition-all focus:ring-1 focus:ring-accent-blue">
                        </div>

                        <!-- Placeholder for removed fixed tax rate -->
                        <div class="opacity-50 text-sm text-gray-400 self-end pb-3">
                            <span data-i18n="label_income_tax_rate_removed">Der ESt-Satz wird nun automatisch über die
                                Progression berechnet.</span>
                        </div>

                        <!-- ESt Calculation & Annualization Modes Group -->
                        <div class="sm:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">

                            <!-- 1. EST CALCULATION MODE SELECTION (Marginal vs Average) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2" data-i18n="label_est_mode">
                                    ESt-Satz-Basis für Projektgewinn
                                </label>
                                <div id="estModeSelection" class="grid grid-cols-1 gap-3">
                                    <div id="est_mode_marginal" onclick="setEstCalculationMode('marginal')"
                                        class="tax-scheme-option p-3 rounded-lg border border-ebay-light hover:border-accent-blue selected">
                                        <p class="font-bold text-sm" data-i18n="est_mode_marginal_title">
                                            Marginalbesteuerung</p>
                                        <p class="text-xs text-gray-400 mt-1" data-i18n="est_mode_marginal_desc">
                                            Berücksichtigt den Progressionseffekt (höchster Steuersatz).</p>
                                    </div>
                                    <div id="est_mode_average" onclick="setEstCalculationMode('average')"
                                        class="tax-scheme-option p-3 rounded-lg border border-ebay-light hover:border-accent-blue">
                                        <p class="font-bold text-sm" data-i18n="est_mode_average_title">
                                            Durchschnittsbesteuerung</p>
                                        <p class="text-xs text-gray-400 mt-1" data-i18n="est_mode_average_desc">Wendelt
                                            den durchschnittlichen Steuersatz auf den Gesamtgewinn an (vereinfacht).</p>
                                    </div>
                                </div>
                            </div>

                            <!-- 2. PROJECT PROFIT ANNUALIZATION MODE SELECTION (x12 vs x1) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2"
                                    data-i18n="label_annualization_mode">
                                    Projektgewinn für ZvE-Hochrechnung
                                </label>
                                <div id="annualizationModeSelection" class="grid grid-cols-1 gap-3">
                                    <div id="annualization_mode_annual" onclick="setAnnualizationMode('annual')"
                                        class="tax-scheme-option p-3 rounded-lg border border-ebay-light hover:border-accent-blue selected">
                                        <p class="font-bold text-sm" data-i18n="annualization_mode_annual_title">
                                            Jährliche Hochrechnung (x12)</p>
                                        <p class="text-xs text-gray-400 mt-1"
                                            data-i18n="annualization_mode_annual_desc">Der Monatsgewinn wird auf 12
                                            Monate hochgerechnet (Standard & steuerlich korrekt).</p>
                                    </div>
                                    <div id="annualization_mode_monthly" onclick="setAnnualizationMode('monthly')"
                                        class="tax-scheme-option p-3 rounded-lg border border-ebay-light hover:border-accent-blue">
                                        <p class="font-bold text-sm" data-i18n="annualization_mode_monthly_title">Nur
                                            Monatsgewinn (x1)</p>
                                        <p class="text-xs text-gray-400 mt-1"
                                            data-i18n="annualization_mode_monthly_desc">Die ESt wird nur basierend auf
                                            dem Monatsgewinn berechnet (Momentaufnahme).</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- End Modes Group -->

                        <div>
                            <label for="ebayFeeRate" class="block text-sm font-medium text-gray-300"
                                data-i18n="label_ebay_fee_rate">
                                Gesamt-eBay-Gebührensatz (FVF + Zahlungsabwicklung) (%)
                            </label>
                            <input type="number" id="ebayFeeRate" value="13" min="1" max="50" step="0.1"
                                oninput="updateProfit()"
                                class="mt-1 w-full p-2 rounded-lg transition-all focus:ring-1 focus:ring-accent-blue">
                        </div>

                        <!-- Outbound Shipping Cost -->
                        <div>
                            <label for="outboundShippingCost" class="block text-sm font-medium text-gray-300"
                                data-i18n="label_shipping_cost">
                                Versandkosten Brutto, bezahlt vom Verkäufer (€)
                            </label>
                            <input type="number" id="outboundShippingCost" value="5.00" min="0" step="0.01"
                                oninput="updateProfit()"
                                class="mt-1 w-full p-2 rounded-lg transition-all focus:ring-1 focus:ring-accent-blue">
                        </div>

                        <!-- Promoted Listing Rate -->
                        <div>
                            <label for="promotedListingRate" class="block text-sm font-medium text-gray-300"
                                data-i18n="label_promoted_rate">
                                Promoted Listing Rate (Ad Spend) (%)
                            </label>
                            <input type="number" id="promotedListingRate" value="0.00" min="0" max="50" step="0.1"
                                oninput="updateProfit()"
                                class="mt-1 w-full p-2 rounded-lg transition-all focus:ring-1 focus:ring-accent-blue">
                        </div>

                        <!-- Prep Costs -->
                        <div>
                            <label for="prepCosts" class="block text-sm font-medium text-gray-300"
                                data-i18n="label_prep_costs">
                                Vorbereitungs- & Etikettierungskosten Brutto (€)
                            </label>
                            <input type="number" id="prepCosts" value="0.50" min="0" step="0.01"
                                oninput="updateProfit()"
                                class="mt-1 w-full p-2 rounded-lg transition-all focus:ring-1 focus:ring-accent-blue">
                        </div>

                        <!-- Miscellaneous Costs -->
                        <div>
                            <label for="miscellaneousCosts" class="block text-sm font-medium text-gray-300"
                                data-i18n="label_misc_costs">
                                Sonstige Stückkosten Brutto (€)
                            </label>
                            <input type="number" id="miscellaneousCosts" value="0.00" min="0" step="0.01"
                                oninput="updateProfit()"
                                class="mt-1 w-full p-2 rounded-lg transition-all focus:ring-1 focus:ring-accent-blue">
                        </div>

                        <!-- Units Sold -->
                        <div class="sm:col-span-2">
                            <label for="unitsSold" class="block text-sm font-medium text-gray-300"
                                data-i18n="label_units_sold">
                                Geschätzte monatliche Verkaufseinheiten
                            </label>
                            <input type="number" id="unitsSold" value="300" min="1" step="1" oninput="updateProfit()"
                                class="mt-1 w-full p-2 rounded-lg transition-all focus:ring-1 focus:ring-accent-blue">
                        </div>
                    </div>
                </details>

            </section>

            <hr class="border-ebay-light">

            <!-- RESULTS SECTION -->
            <section>
                <h2 class="text-xl font-bold text-gray-200 border-b border-ebay-light pb-2 mb-4" data-i18n="h2_results">
                    Ergebnisse im Überblick</h2>

                <div class="grid grid-cols-2 sm:grid-cols-5 gap-3 sm:gap-4">

                    <!-- Box 1: Net Profit / Unit (Before Income Tax) -->
                    <div class="bg-ebay-light p-3 rounded-lg shadow-lg col-span-2 sm:col-span-2">
                        <p class="text-xs font-medium text-gray-300" data-i18n="box_net_profit_pre_est">Netto-Profit /
                            Einheit (vor ESt)</p>
                        <p id="netProfitPreEst"
                            class="text-xl sm:text-3xl font-bold mt-1 text-center py-1 sm:py-2 rounded-lg transition-colors">
                        </p>
                    </div>

                    <!-- Box 2: Final Profit / Unit (After Income Tax) -->
                    <div class="bg-ebay-light p-3 rounded-lg shadow-lg col-span-2 sm:col-span-2">
                        <p class="text-xs font-medium text-gray-300" data-i18n="box_net_profit_post_est">Endgültiger
                            Profit / Einheit (nach ESt)</p>
                        <p id="netProfitPostEst"
                            class="text-xl sm:text-3xl font-bold mt-1 text-center py-1 sm:py-2 rounded-lg transition-colors">
                        </p>
                    </div>

                    <!-- Box 3: ROI -->
                    <div class="bg-ebay-light p-3 rounded-lg shadow-lg col-span-1 sm:col-span-1">
                        <p class="text-xs font-medium text-gray-300" data-i18n="box_roi">ROI</p>
                        <p id="roi"
                            class="text-xl sm:text-2xl font-bold text-profit-green mt-1 text-center py-1 sm:py-2 rounded-lg">
                        </p>
                    </div>

                    <!-- Box 4: Monthly Profit (Pre-Est) -->
                    <div class="bg-ebay-light p-3 rounded-lg shadow-lg col-span-2 sm:col-span-2">
                        <p class="text-xs font-medium text-gray-300" data-i18n="box_monthly_profit_pre_est_title">
                            Geschätzter Monatsgewinn (vor ESt)
                        </p>
                        <p id="monthlyProfitPreEst"
                            class="text-xl sm:text-2xl font-bold text-profit-green mt-1 text-center py-1 sm:py-2 rounded-lg">
                        </p>
                        <p id="monthlyProfitPreEstBasis" class="text-xs text-gray-400 mt-1 text-center"></p>
                        <!-- Basis-Info -->
                    </div>

                    <!-- Box 7: Monthly Profit (Post-Est) -->
                    <div class="bg-ebay-light p-3 rounded-lg shadow-lg col-span-2 sm:col-span-2">
                        <p class="text-xs font-medium text-gray-300" data-i18n="box_monthly_profit_post_est_title">
                            Geschätzter Monatsgewinn (nach ESt)
                        </p>
                        <p id="monthlyProfitPostEstDisplay"
                            class="text-xl sm:text-2xl font-bold mt-1 text-center py-1 sm:py-2 rounded-lg transition-colors">
                        </p>
                        <p id="monthlyProfitPostEstBasis" class="text-xs text-gray-400 mt-1 text-center"></p>
                        <!-- Basis-Info -->
                    </div>

                    <!-- Box 5: Monthly Income Tax Deduction (ESt-Abzug) -->
                    <div class="bg-ebay-light p-3 rounded-lg shadow-lg col-span-1 sm:col-span-1">
                        <p class="text-xs font-medium text-gray-300" data-i18n="box_monthly_income_tax">
                            ESt-Abzug
                        </p>
                        <p id="monthlyIncomeTax"
                            class="text-xl sm:text-2xl font-bold mt-1 text-center py-1 sm:py-2 rounded-lg transition-colors">
                        </p>
                        <p id="monthlyIncomeTaxBasis" class="text-xs text-gray-400 mt-1 text-center"></p>
                        <!-- Basis-Info -->
                    </div>

                    <!-- Box 8: Effective Marginal Tax Rate -->
                    <div class="bg-ebay-light p-3 rounded-lg shadow-lg col-span-1 sm:col-span-1">
                        <p class="text-xs font-medium text-gray-300" data-i18n="box_marginal_tax_rate">
                            Effektiver Steuersatz
                        </p>
                        <p id="marginalTaxRate"
                            class="text-xl sm:text-2xl font-bold text-accent-blue mt-1 text-center py-1 sm:py-2 rounded-lg">
                        </p>
                    </div>

                    <!-- Box 6: Profit Margin (Moved for better flow) -->
                    <div class="bg-ebay-light p-3 rounded-lg shadow-lg col-span-1 sm:col-span-1">
                        <p class="text-xs font-medium text-gray-300" data-i18n="box_profit_margin">Profitmarge</p>
                        <p id="profitMargin"
                            class="text-xl sm:text-2xl font-bold text-profit-green mt-1 text-center py-1 sm:py-2 rounded-lg">
                        </p>
                    </div>
                </div>
            </section>

            <!-- NEW SECTION: CALCULATION EXPLANATION -->
            <section class="mt-6">
                <details class="rounded-xl bg-ebay-light p-4 shadow-inner">
                    <summary class="text-gray-200 hover:text-accent-blue transition-colors"
                        data-i18n="summary_monthly_calc">Wie der Monatsgewinn & die ESt berechnet wird</summary>
                    <div class="pt-4 text-gray-300 text-sm space-y-3">
                        <p data-i18n="calc_monthly_pre">
                            <span class="font-bold">Monatsgewinn (vor ESt)</span>: Dies ist der Netto-Profit pro Einheit
                            (nach Abzug aller Netto-Kosten und Steuern wie MwSt./Vorsteuer) multipliziert mit den
                            geschätzten monatlichen Verkaufseinheiten.
                        </p>
                        <p data-i18n="calc_monthly_est">
                            <span class="font-bold">ESt-Abzug</span>: Berechnet sich aus der Differenz der jährlichen
                            Einkommensteuer zwischen (Bisheriges ZvE) und (Bisheriges ZvE + Jährlicher Projektgewinn).
                            Es wird der **Grundtarif 2024 (Ledige)** verwendet. Die Besteuerung erfolgt zum
                            **Grenzsteuersatz**.
                        </p>
                        <p data-i18n="calc_monthly_post">
                            <span class="font-bold">Monatsgewinn (nach ESt)</span>: Dieser Wert wird berechnet, indem
                            vom Monatsgewinn (vor ESt) der geschätzte Einkommensteuer-Abzug abgezogen wird.
                            <span class="italic text-gray-400 block mt-1">(Monatsgewinn vor ESt - monatlicher
                                ESt-Abzug).</span>
                            Bitte beachten Sie, dass dies eine Vereinfachung ist.
                        </p>
                    </div>
                </details>
            </section>

            <hr class="border-ebay-light">

            <!-- UNIT COST BREAKDOWN SECTION -->
            <section>
                <h2 class="text-xl font-bold text-gray-200 border-b border-ebay-light pb-2 mb-4"
                    data-i18n="h2_breakdown">Stückkosten-Aufschlüsselung (Netto-Basis)</h2>
                <div class="grid grid-cols-3 gap-x-4 gap-y-2 text-sm">

                    <div class="flex justify-between items-center text-gray-300 col-span-2">
                        <span data-i18n="breakdown_gross_selling_price">Brutto-Verkaufspreis:</span>
                        <span id="displayGrossSellingPrice" class="font-semibold text-white"></span>
                    </div>

                    <div class="flex justify-between items-center text-gray-300 col-span-2">
                        <span data-i18n="breakdown_sale_vat">Abzuführende MwSt. (Umsatzsteuer):</span>
                        <span id="displaySaleVAT" class="font-semibold text-loss-red"></span>
                    </div>

                    <!-- Line Divider -->
                    <div class="col-span-3 border-t border-ebay-medium pt-2 mb-1"></div>

                    <div class="flex justify-between items-center font-bold text-gray-100 col-span-2">
                        <span data-i18n="breakdown_net_selling_price">NETTO-VERKAUFSPREIS (Einnahme):</span>
                        <span id="displayNetSellingPrice" class="text-base font-extrabold text-profit-green"></span>
                    </div>

                    <!-- Line Divider -->
                    <div class="col-span-3 border-t border-ebay-medium pt-2 mb-1"></div>

                    <div class="flex justify-between items-center text-gray-300 col-span-2">
                        <span data-i18n="breakdown_ebay_fee_net">eBay Gebühr Netto (abzgl. Vorsteuer):</span>
                        <span id="displayEbayFeeNet" class="font-semibold text-accent-blue"></span>
                    </div>
                    <div class="flex justify-between items-center text-gray-300 col-span-2">
                        <span data-i18n="breakdown_promoted_fee_net">Promoted Listing Gebühr Netto:</span>
                        <span id="displayPromotedFeeNet" class="font-semibold text-accent-blue"></span>
                    </div>
                    <div class="flex justify-between items-center text-gray-300 col-span-2">
                        <span data-i18n="breakdown_shipping_cost_net">Versandkosten Netto:</span>
                        <span id="displayShippingCostNet" class="font-semibold text-accent-blue"></span>
                    </div>
                    <div class="flex justify-between items-center text-gray-300 col-span-2">
                        <span data-i18n="breakdown_prep_misc_net">Vorbereitungs- & Sonstige Kosten Netto:</span>
                        <span id="displayOtherFixedCostsCombinedNet" class="font-semibold text-accent-blue"></span>
                    </div>

                    <!-- Line Divider -->
                    <div class="col-span-3 border-t border-ebay-medium pt-2 mb-1"></div>

                    <!-- SUMMARY: Total Selling Fees NET -->
                    <div class="flex justify-between items-center font-bold text-gray-100 col-span-2">
                        <span class="text-sm" data-i18n="breakdown_total_fees_net">TOTAL NETTO-VERKAUFSKOSTEN:</span>
                        <span id="displayTotalSellingFeesNet" class="text-base text-accent-blue font-extrabold"></span>
                    </div>

                    <!-- COGS Line Item -->
                    <div class="flex justify-between items-center text-gray-100 col-span-2">
                        <span class="text-sm" data-i18n="breakdown_cogs">KOSTEN DER WAREN (COGS):</span>
                        <span id="displayCOGS" class="text-base font-extrabold text-white"></span>
                    </div>

                    <!-- FINAL SUMMARY: Total Investment -->
                    <div
                        class="flex justify-between items-center font-bold text-gray-100 col-span-2 mt-2 pt-2 border-t border-accent-blue">
                        <span class="text-base" data-i18n="breakdown_total_investment">GESAMTINVESTITION NETTO
                            (KOSTENBLOCK):</span>
                        <span id="displayTotalInvestment" class="text-lg text-loss-red font-extrabold"></span>
                    </div>
                </div>
            </section>

        </div>
    </div>

    <script>
        // --- TRANSLATION DATA ---
        const translations = {
            de: {
                title_app: "eBay Profit Rechner (inkl. Progression)",
                subtitle_app: "Berechnung von Rentabilität, Steuern und Kennzahlen für Deutschland.",
                h2_tax_scheme: "Steuerliches Szenario wählen",
                scheme_small_business_title: "Kleinunternehmer",
                scheme_small_business_desc: "Keine MwSt. auf Verkäufe/Gebühren.",
                scheme_standard_vat_title: "Standard-MwSt. (19%)",
                scheme_standard_vat_desc: "MwSt. auf Verkauf abführen, Vorsteuer auf Gebühren abziehen.",
                scheme_margin_tax_title: "Differenzbesteuerung",
                scheme_margin_tax_desc: "MwSt. nur auf die Marge (Einkauf von Privat).",
                h2_primary_inputs: "Primäre Finanzielle Eingaben",
                label_selling_price: "Verkaufspreis Brutto (€)",
                label_cogs: "Kosten der Waren (Einkaufspreis) (€)",
                label_cogs_input_type: "Eingabewert COGS:",
                cogs_input_gross: "Brutto",
                cogs_input_net: "Netto",
                label_cogs_vat_amount: "Davon Vorsteuer (erstattungsfähig):",
                summary_details: "Detaillierte Kosten & Steuerparameter",
                label_target_profit: "Ziel-Nettogewinn (vor ESt) (€)",
                label_already_earned_income: "Bisheriges Jahres-ZvE (Zu versteuerndes Einkommen) (€)",
                label_income_tax_rate_removed: "Der ESt-Satz wird nun automatisch über die Progression berechnet.",
                // ESt Mode
                label_est_mode: "ESt-Satz-Basis für Projektgewinn",
                est_mode_marginal_title: "Marginalbesteuerung",
                est_mode_marginal_desc: "Berücksichtigt den Progressionseffekt (höchster Steuersatz).",
                est_mode_average_title: "Durchschnittsbesteuerung",
                est_mode_average_desc: "Wendelt den durchschnittlichen Steuersatz auf den Gesamtgewinn an (vereinfacht).",
                // Annualization Mode (NEW)
                label_annualization_mode: "Projektgewinn für ZvE-Hochrechnung",
                annualization_mode_annual_title: "Jährliche Hochrechnung (x12)",
                annualization_mode_annual_desc: "Der Monatsgewinn wird auf 12 Monate hochgerechnet (Standard & steuerlich korrekt).",
                annualization_mode_monthly_title: "Nur Monatsgewinn (x1)",
                annualization_mode_monthly_desc: "Die ESt wird nur basierend auf dem Monatsgewinn berechnet (Momentaufnahme).",
                // ESt Basis Keys
                calc_est_marginal_annual_basis: "Basis: Jährl. Gewinn x12, Grenzsteuersatz (Progression).",
                calc_est_marginal_monthly_basis: "Basis: Monatsgewinn x1, Grenzsteuersatz (Momentaufnahme).",
                calc_est_average_annual_basis: "Basis: Jährl. Gewinn x12, Durchschnittssteuersatz (vereinfacht).",
                calc_est_average_monthly_basis: "Basis: Monatsgewinn x1, Durchschnittssteuersatz (vereinfacht).",

                label_ebay_fee_rate: "Gesamt-eBay-Gebührensatz (%)",
                label_shipping_cost: "Versandkosten Brutto, bezahlt vom Verkäufer (€)",
                label_promoted_rate: "Promoted Listing Rate (Ad Spend) (%)",
                label_prep_costs: "Vorbereitungs- & Etikettierungskosten Brutto (€)",
                label_misc_costs: "Sonstige Stückkosten Brutto (€)",
                label_units_sold: "Geschätzte monatliche Verkaufseinheiten",
                h2_results: "Ergebnisse im Überblick",
                box_net_profit_pre_est: "Netto-Profit / Einheit (vor ESt)",
                box_net_profit_post_est: "Endgültiger Profit / Einheit (nach ESt)",
                box_profit_margin: "Profitmarge",
                box_roi: "ROI",
                box_monthly_profit_pre_est_title: "Geschätzter Monatsgewinn (vor ESt)",
                box_monthly_profit_post_est_title: "Geschätzter Monatsgewinn (nach ESt)",
                box_monthly_income_tax: "ESt-Abzug",
                box_marginal_tax_rate: "Effektiver Steuersatz",
                summary_monthly_calc: "Wie der Monatsgewinn & die ESt berechnet wird",
                calc_monthly_pre: "<span class='font-bold'>Monatsgewinn (vor ESt)</span>: Dies ist der Netto-Profit pro Einheit (nach Abzug aller Netto-Kosten und Steuern wie MwSt./Vorsteuer) multipliziert mit den geschätzten monatlichen Verkaufseinheiten.",
                calc_monthly_est: "<span class='font-bold'>ESt-Abzug</span>: Berechnet sich aus der Differenz der jährlichen Einkommensteuer zwischen (Bisheriges ZvE) und (Bisheriges ZvE + Jährlicher Projektgewinn). Es wird der **Grundtarif 2024 (Ledige)** verwendet. Die Besteuerung erfolgt zum **Grenzsteuersatz**.",
                calc_monthly_post: "<span class='font-bold'>Monatsgewinn (nach ESt)</span>: Dieser Wert wird berechnet, indem vom Monatsgewinn (vor ESt) der geschätzte Einkommensteuer-Abzug abgezogen wird. <span class='italic text-gray-400 block mt-1'>(Monatsgewinn vor ESt - monatlicher ESt-Abzug).</span> Bitte beachten Sie, dass dies eine Vereinfachung ist.",
                h2_breakdown: "Stückkosten-Aufschlüsselung (Netto-Basis)",
                breakdown_gross_selling_price: "Brutto-Verkaufspreis:",
                breakdown_sale_vat: "Abzuführende MwSt. (Umsatzsteuer):",
                breakdown_net_selling_price: "NETTO-VERKAUFSPREIS (Einnahme):",
                breakdown_ebay_fee_net: "eBay Gebühr Netto (abzgl. Vorsteuer):",
                breakdown_promoted_fee_net: "Promoted Listing Gebühr Netto:",
                breakdown_shipping_cost_net: "Versandkosten Netto:",
                breakdown_prep_misc_net: "Vorbereitungs- & Sonstige Kosten Netto:",
                breakdown_total_fees_net: "TOTAL NETTO-VERKAUFSKOSTEN:",
                breakdown_cogs: "KOSTEN DER WAREN (COGS):",
                breakdown_total_investment: "GESAMTINVESTITION NETTO (KOSTENBLOCK):",
                calc_min_price_pre: "Min. Brutto-Preis für",
                calc_min_price_post: "Profit:",
                calc_max_cogs_pre: "Max. COGS für",
                calc_max_cogs_post: "Profit:",
                basis_units_sold_pre: "Basiert auf",
                basis_units_sold_post: "Einheiten/Monat",
                lang_en: "English",
                lang_de: "Deutsch",
                currency_symbol: "€",
                mwst_rate: 0.19,
                vat_factor: 1.19,
                hint_cogs_small_business: "Bitte den Einkaufspreis **BRUTTO** eingeben. Es kann keine Vorsteuer abgezogen werden (Kleinunternehmerregelung).",
                hint_cogs_standard_vat_gross: "Sie haben **BRUTTO** gewählt. Bitte den Einkaufspreis inklusive 19% MwSt. eingeben. Die Vorsteuer wird automatisch abgezogen.",
                hint_cogs_standard_vat_net: "Sie haben **NETTO** gewählt. Bitte den Einkaufspreis ohne MwSt. eingeben. Die Vorsteuer wird automatisch berechnet.",
                hint_cogs_margin_tax: "Bitte den Einkaufspreis **BRUTTO** eingeben. Beim Einkauf von Privat kann keine Vorsteuer abgezogen werden (Differenzbesteuerung).",
                info_no_inc_tax: "Keine ESt fällig",
                info_tax_free_zone: "Gesamt-ZvE liegt unter dem Grundfreibetrag (€11.604, 2024).",
            },
            en: {
                title_app: "eBay Profit Analyzer (Incl. Progression)",
                subtitle_app: "Calculate eBay profitability and key metrics including German taxes.",
                h2_tax_scheme: "Select Tax Scheme",
                scheme_small_business_title: "Small Business Owner",
                scheme_small_business_desc: "No VAT charged on sales or deducted on fees.",
                scheme_standard_vat_title: "Standard VAT (19%)",
                scheme_standard_vat_desc: "Pay VAT on sales, reclaim VAT (input tax) on fees.",
                scheme_margin_tax_title: "Margin Scheme Tax",
                scheme_margin_tax_desc: "VAT only on the margin (purchased from private sellers).",
                h2_primary_inputs: "Primary Financial Inputs",
                label_selling_price: "Selling Price Gross (€)",
                label_cogs: "Cost of Goods Sold (Purchase Price) (€)",
                label_cogs_input_type: "COGS Input Value:",
                cogs_input_gross: "Gross",
                cogs_input_net: "Net",
                label_cogs_vat_amount: "Thereof Input VAT (Reclaimable):",
                summary_details: "Detailed Costs & Tax Parameters",
                label_target_profit: "Target Net Profit (pre-Inc. Tax) (€)",
                label_already_earned_income: "Previous Annual Taxable Income (ZvE) (€)",
                label_income_tax_rate_removed: "The Inc. Tax Rate is now calculated automatically via progression.",
                // ESt Mode
                label_est_mode: "Inc. Tax Rate Basis for Project Profit",
                est_mode_marginal_title: "Marginal Taxation",
                est_mode_marginal_desc: "Accounts for the progression effect (highest tax bracket).",
                est_mode_average_title: "Average Taxation",
                est_mode_average_desc: "Applies the average tax rate to the total profit (simplified).",
                // Annualization Mode (NEW)
                label_annualization_mode: "Project Profit Annualization for ZvE",
                annualization_mode_annual_title: "Annual Projection (x12)",
                annualization_mode_annual_desc: "Monthly profit is projected over 12 months for Inc. Tax calculation (Standard & correct).",
                annualization_mode_monthly_title: "Monthly Profit Only (x1)",
                annualization_mode_monthly_desc: "Inc. Tax is calculated based only on the monthly profit (Snapshot).",
                // ESt Basis Keys
                calc_est_marginal_annual_basis: "Basis: Annual Profit x12, Marginal Tax Rate (Progression).",
                calc_est_marginal_monthly_basis: "Basis: Monthly Profit x1, Marginal Tax Rate (Snapshot).",
                calc_est_average_annual_basis: "Basis: Annual Profit x12, Average Tax Rate (Simplified).",
                calc_est_average_monthly_basis: "Basis: Monthly Profit x1, Average Tax Rate (Simplified).",

                label_ebay_fee_rate: "Total eBay Fee Rate (%)",
                label_shipping_cost: "Outbound Shipping Cost Gross (€)",
                label_promoted_rate: "Promoted Listing Rate (Ad Spend) (%)",
                label_prep_costs: "Prep & Labeling Costs Gross (€)",
                label_misc_costs: "Miscellaneous Per-Unit Costs Gross (€)",
                label_units_sold: "Estimated Monthly Units Sold",
                h2_results: "Results Overview",
                box_net_profit_pre_est: "Net Profit / Unit (pre-Inc. Tax)",
                box_net_profit_post_est: "Final Profit / Unit (post-Inc. Tax)",
                box_profit_margin: "Profit Margin",
                box_roi: "ROI",
                box_monthly_profit_pre_est_title: "Estimated Monthly Profit (pre-Inc. Tax)",
                box_monthly_profit_post_est_title: "Estimated Monthly Profit (post-Inc. Tax)",
                box_monthly_income_tax: "Inc. Tax Deduction",
                box_marginal_tax_rate: "Effective Tax Rate",
                summary_monthly_calc: "How Monthly Profit & Inc. Tax is Calculated",
                calc_monthly_pre: "<span class='font-bold'>Monthly Profit (pre-Inc. Tax)</span>: This is the Net Profit per unit (after deducting all net costs and taxes like VAT/Input Tax) multiplied by the estimated monthly units sold.",
                calc_monthly_est: "<span class='font-bold'>Inc. Tax Deduction</span>: Calculated as the difference in annual income tax between (Previous ZvE) and (Previous ZvE + Annual Project Profit). The **Basic Tax Table 2024 (Single Filer)** is used. Taxation is applied at the **Marginal Tax Rate**.",
                calc_monthly_post: "<span class='font-bold'>Monthly Profit (post-Inc. Tax)</span>: This value is calculated by subtracting the estimated income tax deduction from the Monthly Profit (pre-Inc. Tax). <span class='italic text-gray-400 block mt-1'>(Monthly Profit pre-Inc. Tax - Monthly Inc. Tax Deduction).</span> Please note this is a simplification.",
                h2_breakdown: "Unit Cost Breakdown (Net Basis)",
                breakdown_gross_selling_price: "Gross Selling Price:",
                breakdown_sale_vat: "VAT to be remitted (Sales Tax):",
                breakdown_net_selling_price: "NET SELLING PRICE (Revenue):",
                breakdown_ebay_fee_net: "eBay Fee Net (less input tax):",
                breakdown_promoted_fee_net: "Promoted Listing Fee Net:",
                breakdown_shipping_cost_net: "Shipping Cost Net:",
                breakdown_prep_misc_net: "Prep & Other Costs Net:",
                breakdown_total_fees_net: "TOTAL NET SELLING COSTS:",
                breakdown_cogs: "COST OF GOODS SOLD (COGS):",
                breakdown_total_investment: "TOTAL NET INVESTMENT (COST BLOCK):",
                calc_min_price_pre: "Min. Gross Price for",
                calc_min_price_post: "Profit:",
                calc_max_cogs_pre: "Max. COGS for",
                calc_max_cogs_post: "Profit:",
                basis_units_sold_pre: "Based on",
                basis_units_sold_post: "units/month",
                lang_en: "English",
                lang_de: "German",
                currency_symbol: "€",
                mwst_rate: 0.19,
                vat_factor: 1.19,
                hint_cogs_small_business: "Please enter the purchase price **GROSS**. No input VAT can be reclaimed (Small Business Exemption).",
                hint_cogs_standard_vat_gross: "You selected **GROSS**. Please enter the purchase price including 19% VAT. Input VAT will be automatically deducted.",
                hint_cogs_standard_vat_net: "You selected **NET**. Please enter the purchase price Excl. VAT. Input VAT will be automatically calculated.",
                hint_cogs_margin_tax: "Please enter the purchase price **GROSS**. Input VAT cannot be reclaimed in this scheme (purchased from private seller).",
                info_no_inc_tax: "No Inc. Tax Due",
                info_tax_free_zone: "Total ZvE is below the tax-free allowance (€11,604, 2024).",
            }
        };

        let currentLang = 'de';
        let currentTaxScheme = 'small_business';
        let cogsInputType = 'net';
        let estCalculationMode = 'marginal';
        let annualizationMode = 'annual'; // NEW: Default to annual projection (x12)

        // --- GERMAN INCOME TAX CALCULATION (Grundtarif 2024 - Simplified for single filer) ---

        /**
         * Calculates the annual German income tax (ESt) for a single filer (Grundtarif) based on 2024 tax data.
         * Note: This is a simplification. It ignores church tax, solidarity surcharge (Soli), and health/social insurance.
         * * @param {number} zve - Taxable Income (Zu versteuerndes Einkommen) in Euros.
         * @returns {number} The calculated annual income tax (ESt) in Euros.
         */
        function calculateIncomeTax(zve) {
            zve = Math.floor(zve); // Taxation is based on full Euros

            // 2024 Tax Brackets (Grundtarif)
            const LIMIT_1 = 11604; // Zone 1 end (Grundfreibetrag)
            const LIMIT_2 = 17005; // Zone 2 end (Low progression)
            const LIMIT_3 = 66760; // Zone 3 end (Mid progression)
            const LIMIT_4 = 277825; // Zone 4 end (Flat 42%)

            let tax = 0;

            if (zve <= LIMIT_1) {
                // Zone 1: Tax-Free
                tax = 0;

            } else if (zve <= LIMIT_2) {
                // Zone 2: 14% to ~24% progression
                const Y = (zve - LIMIT_1) / 10000;
                tax = (979.18 * Y + 1400) * Y;

            } else if (zve <= LIMIT_3) {
                // Zone 3: ~24% to 42% progression
                const Z = (zve - LIMIT_2) / 10000;
                tax = (192.59 * Z + 2397) * Z + 960.94;

            } else if (zve <= LIMIT_4) {
                // Zone 4: Flat 42%
                tax = 0.42 * zve - 10751.49;

            } else {
                // Zone 5: Flat 45% (Reichensteuer)
                tax = 0.45 * zve - 19045.73;
            }

            return Math.max(0, tax); // Tax can't be negative
        }

        // --- CORE LOGIC FUNCTIONS ---

        /**
         * Sets the COGS input type (Gross/Net) for the Standard VAT scheme.
         * @param {string} type - 'gross' or 'net'.
         * @param {boolean} shouldSave - Whether to save the new type to localStorage. Default is true.
         */
        function setCogsInputType(type, shouldSave = true) {
            if (type !== 'gross' && type !== 'net') return;
            cogsInputType = type;

            // Update UI selection
            document.querySelectorAll('.cogs-input-type-btn').forEach(el => {
                el.classList.remove('selected');
            });
            document.getElementById(`cogs_input_${type}_btn`).classList.add('selected');

            if (shouldSave) {
                localStorage.setItem('ebayCalc_cogsInputType', type);
            }
            // Recalculate everything
            updateProfit(shouldSave);
        }

        /**
         * Sets the ESt calculation mode (Marginal/Average).
         * @param {string} mode - 'marginal' or 'average'.
         * @param {boolean} shouldSave - Whether to save the new mode to localStorage. Default is true.
         */
        function setEstCalculationMode(mode, shouldSave = true) {
            if (mode !== 'marginal' && mode !== 'average') return;
            estCalculationMode = mode;

            // Update UI selection
            document.querySelectorAll('#estModeSelection .tax-scheme-option').forEach(el => {
                el.classList.remove('selected');
            });
            document.getElementById(`est_mode_${mode}`).classList.add('selected');

            if (shouldSave) {
                localStorage.setItem('ebayCalc_estCalculationMode', mode);
            }
            updateProfit(shouldSave);
        }

        /**
         * NEW: Sets the annualization mode (Annual/Monthly).
         * @param {string} mode - 'annual' or 'monthly'.
         * @param {boolean} shouldSave - Whether to save the new mode to localStorage. Default is true.
         */
        function setAnnualizationMode(mode, shouldSave = true) {
            if (mode !== 'annual' && mode !== 'monthly') return;
            annualizationMode = mode;

            // Update UI selection
            document.querySelectorAll('#annualizationModeSelection .tax-scheme-option').forEach(el => {
                el.classList.remove('selected');
            });
            document.getElementById(`annualization_mode_${mode}`).classList.add('selected');

            if (shouldSave) {
                localStorage.setItem('ebayCalc_annualizationMode', mode);
            }
            updateProfit(shouldSave);
        }


        /**
         * Saves all relevant input values and the tax scheme/language to the browser's local storage.
         */
        function saveSettings() {
            const inputs = [
                'sellingPrice', 'cogs', 'targetProfit', 'ebayFeeRate',
                'outboundShippingCost', 'promotedListingRate', 'prepCosts',
                'miscellaneousCosts', 'unitsSold', 'alreadyEarnedIncome', 'taxYear'
            ];

            inputs.forEach(id => {
                const value = document.getElementById(id).value;
                localStorage.setItem(`ebayCalc_${id}`, value);
            });
            localStorage.setItem('ebayCalc_language', currentLang);
            localStorage.setItem('ebayCalc_taxScheme', currentTaxScheme);
            localStorage.setItem('ebayCalc_cogsInputType', cogsInputType);
            localStorage.setItem('ebayCalc_estCalculationMode', estCalculationMode);
            localStorage.setItem('ebayCalc_annualizationMode', annualizationMode); // NEW
        }

        /**
         * Loads all saved input values, language, and tax scheme from local storage.
         */
        function loadSettings() {
            const inputs = [
                'sellingPrice', 'cogs', 'targetProfit', 'ebayFeeRate',
                'outboundShippingCost', 'promotedListingRate', 'prepCosts',
                'miscellaneousCosts', 'unitsSold', 'alreadyEarnedIncome', 'taxYear'
            ];

            inputs.forEach(id => {
                const savedValue = localStorage.getItem(`ebayCalc_${id}`);
                // Only load if saved value exists, otherwise keep the default
                if (savedValue !== null) {
                    document.getElementById(id).value = savedValue;
                }
            });

            const savedLang = localStorage.getItem('ebayCalc_language') || 'de';
            const savedScheme = localStorage.getItem('ebayCalc_taxScheme') || 'small_business';
            const savedCogsType = localStorage.getItem('ebayCalc_cogsInputType') || 'net';
            const savedEstMode = localStorage.getItem('ebayCalc_estCalculationMode') || 'marginal';
            const savedAnnualizationMode = localStorage.getItem('ebayCalc_annualizationMode') || 'annual'; // NEW

            // Set global variables
            currentLang = savedLang;
            currentTaxScheme = savedScheme;
            cogsInputType = savedCogsType;
            estCalculationMode = savedEstMode;
            annualizationMode = savedAnnualizationMode; // NEW

            // Update selectors
            document.getElementById('languageSelector').value = savedLang;

            // Set input type and tax scheme. setTaxScheme will call updateProfit
            setCogsInputType(savedCogsType, false);
            setTaxScheme(savedScheme, false);
            setEstCalculationMode(savedEstMode, false);
            setAnnualizationMode(savedAnnualizationMode, false); // NEW
        }

        /**
         * Sets the tax scheme and triggers an update.
         * @param {string} scheme - 'small_business', 'standard_vat', or 'margin_tax'.
         * @param {boolean} shouldSave - Whether to save the new scheme to localStorage. Default is true.
         */
        function setTaxScheme(scheme, shouldSave = true) {
            currentTaxScheme = scheme;

            // Update UI selection
            document.querySelectorAll('#taxSchemeSelection .tax-scheme-option').forEach(el => {
                el.classList.remove('selected');
            });
            document.getElementById(`scheme_${scheme}`).classList.add('selected');

            // Control visibility of COGS input type selector
            const cogsSelector = document.getElementById('cogsInputTypeSelector');
            if (scheme === 'standard_vat') {
                cogsSelector.classList.remove('hidden');
            } else {
                cogsSelector.classList.add('hidden');
            }

            if (shouldSave) {
                saveSettings();
            }
            // Recalculate everything
            updateProfit(shouldSave);
        }

        /**
         * Updates the UI text based on the selected language and saves the setting.
         * @param {string} lang - 'en' or 'de'.
         */
        function setLanguage(lang) {
            currentLang = lang;
            const langData = translations[lang];

            // 1. SAVE LANGUAGE TO LOCAL STORAGE
            localStorage.setItem('ebayCalc_language', lang);

            // 2. Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (langData[key]) {
                    // Check if content needs to be set as innerHTML (for bold/italic tags in the calculation explanation)
                    if (key.startsWith('calc_')) {
                        element.innerHTML = langData[key];
                    } else {
                        element.textContent = langData[key];
                    }
                }
            });

            // 3. Set the document title
            document.title = langData['title_app'];

            // 4. Ensure the correct option in the selector is selected
            document.getElementById('languageSelector').value = lang;

            // 5. Re-run profit calculation to update currency displays and hints
            updateProfit(false);
        }

        /**
         * Returns the correct currency symbol for the current language.
         */
        function getCurrencySymbol() {
            return translations[currentLang]?.currency_symbol || '€';
        }

        /**
         * Returns the VAT factor (1 + VAT Rate) for the current language.
         */
        function getVatFactor() {
            return translations[currentLang]?.vat_factor || 1.19;
        }

        /**
         * Formats a number into a currency string (e.g., $X.XX or €X.XX)
         * @param {number} value - The number to format.
         * @returns {string} - The formatted currency string.
         */
        function formatCurrency(value) {
            const symbol = getCurrencySymbol();
            return `${symbol}${value.toFixed(2)}`;
        }

        /**
         * Formats a number into a percentage string (X.X%)
         * @param {number} value - The number to format.
         * @returns {string} - The formatted percentage string.
         */
        function formatPercentage(value) {
            return `${value.toFixed(1)}%`;
        }

        /**
         * Main function to read inputs, perform calculations, and update the UI.
         * @param {boolean} shouldSave - Flag to control if settings should be saved after update. Defaults to true for user input.
         */
        function updateProfit(shouldSave = true) {
            // --- 1. Get Input Values and Tax Parameters ---
            const sellingPriceGross = parseFloat(document.getElementById('sellingPrice').value) || 0;
            const cogs = parseFloat(document.getElementById('cogs').value) || 0; // The value entered by the user

            const ebayFeeRate = parseFloat(document.getElementById('ebayFeeRate').value) / 100 || 0;
            const promotedListingRate = parseFloat(document.getElementById('promotedListingRate').value) / 100 || 0;
            const outboundShippingCostGross = parseFloat(document.getElementById('outboundShippingCost').value) || 0;
            const prepCostsGross = parseFloat(document.getElementById('prepCosts').value) || 0;
            const miscellaneousCostsGross = parseFloat(document.getElementById('miscellaneousCosts').value) || 0;

            const unitsSold = parseInt(document.getElementById('unitsSold').value) || 0;
            const targetProfit = parseFloat(document.getElementById('targetProfit').value) || 0;
            const alreadyEarnedIncome = parseFloat(document.getElementById('alreadyEarnedIncome').value) || 0;


            const vatFactor = getVatFactor(); // 1.19
            const taxScheme = currentTaxScheme;
            const langData = translations[currentLang];

            let saleVAT = 0;
            let netSellingPrice = sellingPriceGross;
            let ebayFeeNet = 0;
            let promotedFeeNet = 0;
            let outboundShippingCostNet = outboundShippingCostGross;
            let prepCostsNet = prepCostsGross;
            let miscellaneousCostsNet = miscellaneousCostsGross;

            let cogsFinalNetExpense = cogs;
            let cogsVAT = 0;

            // --- 2. Calculate VAT and Net Costs based on Tax Scheme ---

            if (taxScheme === 'standard_vat') {
                // A) Net Selling Price & Sale VAT
                netSellingPrice = sellingPriceGross / vatFactor;
                saleVAT = sellingPriceGross - netSellingPrice;

                // B) Net Costs (Vorsteuer deduction assumed for all fees/costs)
                const ebayFeeGross = sellingPriceGross * ebayFeeRate;
                ebayFeeNet = ebayFeeGross / vatFactor;

                const promotedFeeGross = sellingPriceGross * promotedListingRate;
                promotedFeeNet = promotedFeeGross / vatFactor;

                outboundShippingCostNet = outboundShippingCostGross / vatFactor;
                prepCostsNet = prepCostsGross / vatFactor;
                miscellaneousCostsNet = miscellaneousCostsGross / vatFactor;

                // C) COGS VAT (Vorsteuer) and COGS Net calculation based on COGS Input Type
                if (cogsInputType === 'gross') {
                    cogsFinalNetExpense = cogs / vatFactor;
                    cogsVAT = cogs - cogsFinalNetExpense;
                } else { // 'net' - User entered Net COGS.
                    cogsFinalNetExpense = cogs;
                    cogsVAT = cogs * (vatFactor - 1);
                }

            } else if (taxScheme === 'margin_tax') {
                // A) Net Selling Price & Sale VAT 
                const grossMargin = sellingPriceGross - cogs;

                if (grossMargin > 0) {
                    const netMargin = grossMargin / vatFactor;
                    saleVAT = grossMargin - netMargin;
                    netSellingPrice = cogs + netMargin;
                } else {
                    saleVAT = 0;
                    netSellingPrice = sellingPriceGross;
                }

                // B) Net Costs (Vorsteuer deduction NOT applicable for Margin scheme costs)
                ebayFeeNet = sellingPriceGross * ebayFeeRate;
                promotedFeeNet = sellingPriceGross * promotedListingRate;

                // Other costs are Gross
                outboundShippingCostNet = outboundShippingCostGross;
                prepCostsNet = prepCostsGross;
                miscellaneousCostsNet = miscellaneousCostsGross;

                // C) COGS is Gross and not subject to VAT reclaim
                cogsFinalNetExpense = cogs;
                cogsVAT = 0;

            } else { // 'small_business'
                // All values are Gross/Net (since no VAT is charged/reclaimed)
                netSellingPrice = sellingPriceGross;
                ebayFeeNet = sellingPriceGross * ebayFeeRate;
                promotedFeeNet = sellingPriceGross * promotedListingRate;

                // COGS is Gross and not subject to VAT reclaim
                cogsFinalNetExpense = cogs;
                cogsVAT = 0;
            }

            // Sum of all 'Other Fixed Costs' Net
            const totalOtherFixedCostsNet = prepCostsNet + miscellaneousCostsNet;

            // Total Net Selling Costs (Fees + Shipping + Prep/Misc)
            const totalNetSellingFees = ebayFeeNet + promotedFeeNet + outboundShippingCostNet + totalOtherFixedCostsNet;

            // Total Investment per unit (COGS NET + all Net Fees)
            const totalInvestmentPerUnit = cogsFinalNetExpense + totalNetSellingFees;

            // --- 3. Calculate Profit Metrics (Per Unit) ---

            // Net Profit (pre-Income Tax)
            const netProfitPreEst = netSellingPrice - totalInvestmentPerUnit;

            // Calculate Profit Margin: (Net Profit / Net Selling Price) * 100
            const profitMargin = (netSellingPrice > 0) ? (netProfitPreEst / netSellingPrice) * 100 : 0;

            // Calculate ROI: (Net Profit / Total Investment) * 100
            const roi = (totalInvestmentPerUnit > 0) ? (netProfitPreEst / totalInvestmentPerUnit) * 100 : 0;

            // --- 4. Calculate Total Monthly Profit and Income Tax (PROGRESSION LOGIC) ---

            const monthlyProfitPreEst = netProfitPreEst * unitsSold;

            let annualProjectProfit;
            let annualizationBasisSegment;

            // NEW LOGIC: Apply annualization factor (x12 or x1)
            if (annualizationMode === 'monthly') {
                annualProjectProfit = monthlyProfitPreEst;
                annualizationBasisSegment = 'monthly';
            } else { // 'annual'
                annualProjectProfit = monthlyProfitPreEst * 12;
                annualizationBasisSegment = 'annual';
            }

            // Annual ZvE WITHOUT the project
            const zveBase = alreadyEarnedIncome;
            // Annual ZvE WITH the project
            const zveTotal = alreadyEarnedIncome + annualProjectProfit;

            // Calculate Annual Tax for both scenarios
            const annualTaxBase = calculateIncomeTax(zveBase);
            const annualTaxTotal = calculateIncomeTax(zveTotal);

            // --- Marginal Tax Calculation (The tax increase caused *only* by the project) ---
            const annualTaxIncreaseMarginal = annualTaxTotal - annualTaxBase;

            // --- Average Tax Calculation (Simplification) ---
            const totalAnnualTax = annualTaxTotal;
            const averageTaxRate = zveTotal > 0 ? totalAnnualTax / zveTotal : 0;
            const annualTaxIncreaseAverage = annualProjectProfit * averageTaxRate;

            let annualTaxIncrease;
            let marginalTaxRate;
            let taxBasisExplanationKey;

            if (estCalculationMode === 'average') {
                // Use Average Taxation
                annualTaxIncrease = annualTaxIncreaseAverage;

                // The displayed 'Marginal Tax Rate' is actually the average rate in this mode
                marginalTaxRate = averageTaxRate * 100;
                taxBasisExplanationKey = `calc_est_average_${annualizationBasisSegment}_basis`;

            } else { // 'marginal' - Default/Accurate Mode
                // Use Marginal Taxation
                annualTaxIncrease = annualTaxIncreaseMarginal;

                // Effective Marginal Tax Rate for the project
                marginalTaxRate = annualProjectProfit > 0 ? (annualTaxIncrease / annualProjectProfit) * 100 : 0;
                taxBasisExplanationKey = `calc_est_marginal_${annualizationBasisSegment}_basis`;
            }

            // Monthly Income Tax Deduction (Divide the annual tax increase by 12, even if we only used x1 for calculation)
            // This normalizes the tax deduction back to a monthly basis for UI consistency.
            const monthlyIncomeTax = annualTaxIncrease / 12;

            // Final Profit (after Income Tax)
            const monthlyProfitPostEstValue = monthlyProfitPreEst - monthlyIncomeTax;
            const netProfitPostEst = netProfitPreEst - (monthlyIncomeTax / unitsSold); // Calculate unit profit based on monthly tax deduction

            // --- 5. Inverse Calculations for Key Metrics (Unchanged) ---

            // 5a. Calculate MAX COGS
            const maxCOGSNetExpense = netSellingPrice - totalNetSellingFees - targetProfit;

            // Convert maxCOGSNetExpense back to the user's input type for display if Standard VAT is used
            let maxCogsDisplayValue = maxCOGSNetExpense;
            if (taxScheme === 'standard_vat' && cogsInputType === 'gross') {
                maxCogsDisplayValue = maxCOGSNetExpense * vatFactor;
            }

            // 5b. Calculate MIN Selling Price (Gross) - Simplified inverse calculation as progression is too complex to reverse
            let minSellingPriceGross = 0;
            const totalFeesRate = ebayFeeRate + promotedListingRate;

            // Assume the target profit has an effective tax rate of 25% for Min Price calculation (for simplicity)
            const assumedPostTaxFactor = 1 - (marginalTaxRate / 100);
            const targetNetRevenueNeeded = (targetProfit / assumedPostTaxFactor) + cogsFinalNetExpense + totalNetSellingFees;

            if (taxScheme === 'standard_vat') {
                const priceDependentFactor = 1 - totalFeesRate;

                if (priceDependentFactor > 0) {
                    minSellingPriceGross = (targetNetRevenueNeeded) * vatFactor / priceDependentFactor;
                } else {
                    minSellingPriceGross = Infinity;
                }
            } else if (taxScheme === 'margin_tax') {
                minSellingPriceGross = targetNetRevenueNeeded * 1.05; // Heuristic
            } else { // small_business
                const priceDependentFactor = 1 - totalFeesRate;
                if (priceDependentFactor > 0) {
                    minSellingPriceGross = targetNetRevenueNeeded / priceDependentFactor;
                } else {
                    minSellingPriceGross = Infinity;
                }
            }
            // Ensure min selling price is always > 0
            minSellingPriceGross = Math.max(0.01, minSellingPriceGross);


            // --- 6. Update UI with Results ---

            // Profit Boxes (Per Unit)
            const netProfitPreEstElement = document.getElementById('netProfitPreEst');
            const netProfitPostEstElement = document.getElementById('netProfitPostEst');

            netProfitPreEstElement.textContent = formatCurrency(netProfitPreEst);
            netProfitPostEstElement.textContent = formatCurrency(netProfitPostEst);

            // Styling logic (based on post-tax profit)
            [netProfitPreEstElement, netProfitPostEstElement].forEach(el => {
                el.classList.remove('bg-profit-green', 'bg-loss-red', 'text-ebay-dark', 'bg-yellow-400');
            });

            if (netProfitPostEst >= targetProfit) {
                netProfitPreEstElement.classList.add('bg-profit-green', 'text-ebay-dark');
                netProfitPostEstElement.classList.add('bg-profit-green', 'text-ebay-dark');
            } else if (netProfitPostEst >= 0) {
                netProfitPreEstElement.classList.add('bg-yellow-400', 'text-ebay-dark');
                netProfitPostEstElement.classList.add('bg-yellow-400', 'text-ebay-dark');
            } else {
                netProfitPreEstElement.classList.add('bg-loss-red', 'text-ebay-dark');
                netProfitPostEstElement.classList.add('bg-loss-red', 'text-ebay-dark');
            }

            // Other Boxes
            document.getElementById('profitMargin').textContent = formatPercentage(profitMargin);
            document.getElementById('roi').textContent = formatPercentage(roi);

            // Monthly Profit Boxes (Total)
            document.getElementById('monthlyProfitPreEst').textContent = formatCurrency(monthlyProfitPreEst);

            // Update Basis Info for Monthly Profit Pre-Est/Post-Est
            const unitsBasisText = `${langData['basis_units_sold_pre']} ${unitsSold} ${langData['basis_units_sold_post']}`;
            document.getElementById('monthlyProfitPreEstBasis').textContent = unitsBasisText;
            document.getElementById('monthlyProfitPostEstBasis').textContent = unitsBasisText;

            const monthlyIncomeTaxElement = document.getElementById('monthlyIncomeTax');
            const monthlyProfitPostEstDisplayElement = document.getElementById('monthlyProfitPostEstDisplay');
            const marginalTaxRateElement = document.getElementById('marginalTaxRate');

            // --- Handling the ZERO Tax Case (Total ZvE is still within Grundfreibetrag) ---
            if (annualTaxIncrease <= 0.01) {

                monthlyIncomeTaxElement.textContent = langData['info_no_inc_tax'];
                monthlyIncomeTaxElement.classList.remove('text-loss-red');
                monthlyIncomeTaxElement.classList.add('text-profit-green');

                // Show pre-est profit as post-est profit
                monthlyProfitPostEstDisplayElement.textContent = formatCurrency(monthlyProfitPreEst);
                monthlyProfitPostEstDisplayElement.classList.remove('text-loss-red', 'text-yellow-400');
                monthlyProfitPostEstDisplayElement.classList.add('text-profit-green');

                // Set basis text to explain why
                document.getElementById('monthlyIncomeTaxBasis').textContent = langData['info_tax_free_zone'];

                // Display 0% for marginal rate
                marginalTaxRateElement.textContent = formatPercentage(0);

            } else {
                // Standard tax calculation output
                monthlyIncomeTaxElement.textContent = formatCurrency(monthlyIncomeTax);
                monthlyIncomeTaxElement.classList.remove('text-profit-green');
                monthlyIncomeTaxElement.classList.add('text-loss-red');

                monthlyProfitPostEstDisplayElement.textContent = formatCurrency(monthlyProfitPostEstValue);

                // Styling logic for monthly post-tax
                monthlyProfitPostEstDisplayElement.classList.remove('text-profit-green', 'text-loss-red', 'text-yellow-400');
                if (monthlyProfitPostEstValue >= targetProfit * unitsSold) {
                    monthlyProfitPostEstDisplayElement.classList.add('text-profit-green');
                } else if (monthlyProfitPostEstValue >= 0) {
                    monthlyProfitPostEstDisplayElement.classList.add('text-yellow-400');
                } else {
                    monthlyProfitPostEstDisplayElement.classList.add('text-loss-red');
                }

                marginalTaxRateElement.textContent = formatPercentage(marginalTaxRate);

                // Set the specific ESt calculation mode basis text
                document.getElementById('monthlyIncomeTaxBasis').textContent = langData[taxBasisExplanationKey];
            }

            // --- 7. Update Unit Cost Breakdown Section (Unchanged) ---
            document.getElementById('displayGrossSellingPrice').textContent = formatCurrency(sellingPriceGross);
            document.getElementById('displaySaleVAT').textContent = formatCurrency(saleVAT);
            document.getElementById('displayNetSellingPrice').textContent = formatCurrency(netSellingPrice);

            document.getElementById('displayEbayFeeNet').textContent = formatCurrency(ebayFeeNet);
            document.getElementById('displayPromotedFeeNet').textContent = formatCurrency(promotedFeeNet);
            document.getElementById('displayShippingCostNet').textContent = formatCurrency(outboundShippingCostNet);

            document.getElementById('displayOtherFixedCostsCombinedNet').textContent = formatCurrency(totalOtherFixedCostsNet);

            document.getElementById('displayTotalSellingFeesNet').textContent = formatCurrency(totalNetSellingFees);

            document.getElementById('displayCOGS').textContent = formatCurrency(cogsFinalNetExpense);

            document.getElementById('displayTotalInvestment').textContent = formatCurrency(totalInvestmentPerUnit);

            // --- 8. Update Labels with Inverse Metrics and VAT Hint (Unchanged) ---

            const minPriceValueContainer = document.getElementById('minPriceValue');
            const maxCogsValueContainer = document.getElementById('maxCogsValueContainer');
            const cogsTaxHintContainer = document.getElementById('cogsTaxHint');
            const cogsVATAmountContainer = document.getElementById('cogsVATAmountContainer');
            const cogsVATAmountElement = document.getElementById('cogsVATAmount');

            const targetProfitText = formatCurrency(targetProfit);

            // Update COGS Tax Hint based on scheme
            let hintKey = '';

            if (taxScheme === 'standard_vat') {
                cogsVATAmountContainer.style.display = 'block';
                cogsVATAmountElement.textContent = formatCurrency(cogsVAT);

                if (cogsInputType === 'gross') {
                    hintKey = 'hint_cogs_standard_vat_gross';
                } else { // 'net'
                    hintKey = 'hint_cogs_standard_vat_net';
                }
            } else { // other schemes
                cogsVATAmountContainer.style.display = 'none';
                if (taxScheme === 'small_business') {
                    hintKey = 'hint_cogs_small_business';
                } else if (taxScheme === 'margin_tax') {
                    hintKey = 'hint_cogs_margin_tax';
                }
            }
            cogsTaxHintContainer.textContent = langData[hintKey] || '';


            // Update Selling Price Label content (Min Price)
            const formattedMinPrice = formatCurrency(minSellingPriceGross);
            let minPriceColorClass = (sellingPriceGross >= minSellingPriceGross) ? 'text-profit-green' : 'text-loss-red';

            minPriceValueContainer.innerHTML = `
                (<span class="font-semibold ${minPriceColorClass}">${langData['calc_min_price_pre']} ${targetProfitText} ${langData['calc_min_price_post']} ${formattedMinPrice}</span>)
            `;


            // Update COGS Label content (Max COGS)
            const formattedMaxCOGS = formatCurrency(maxCogsDisplayValue);
            let maxCogsColorClass = (cogs <= maxCogsDisplayValue) ? 'text-profit-green' : 'text-loss-red';

            maxCogsValueContainer.innerHTML = `
                (<span class="font-semibold ${maxCogsColorClass}">${langData['calc_max_cogs_pre']} ${targetProfitText} ${langData['calc_max_cogs_post']} ${formattedMaxCOGS}</span>)
            `;

            // --- 9. Save Settings if triggered by user input ---
            if (shouldSave) {
                saveSettings();
            }
        }

        // Set up the initial listener on window load
        window.onload = function () {
            // 1. Load saved settings (values, language, and tax scheme)
            loadSettings();

            // 2. Set language (which triggers the first updateProfit)
            setLanguage(currentLang);
        };
    </script>
</body>

</html>